import { Tabs } from "nextra/components";

# API

## Functions

<Tabs items={['App router', 'Page router']}>
  <Tabs.Tab>
    The following is used only for App router.

    ## `getPropsFromParams` function

    `getPropsFromParams` is a function that returns the props for the [`NextAdmin`](#nextadmin--component) component. It accepts one argument which is an object with the following properties:

    - `params`: the array of route params retrieved from the [optional catch-all segment](https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes#optional-catch-all-segments)
    - `searchParams`: the query params [retrieved from the page](https://nextjs.org/docs/app/api-reference/file-conventions/page#searchparams-optional)
    - `options`: the [options](#next-admin-options) object
    - `schema`: the json schema generated by the `prisma generate` command
    - `prisma`: your Prisma client instance
    - `action`: the [server action](https://nextjs.org/docs/app/api-reference/functions/server-actions) used to submit the form. It should be your own action, that wraps the `submitForm` action imported from `@premieroctet/next-admin/dist/actions`.

  </Tabs.Tab>
  <Tabs.Tab>
    The following is used only for Page router

    ## `nextAdminRouter` function

    `nextAdminRouter` is a function that returns a promise of a _Node Router_ that you can use in your getServerSideProps function to start using Next Admin. Its usage is only related to Page router.

    Usage example:

    ```ts
    // pages/api/admin/[[...nextadmin]].ts
    export const getServerSideProps: GetServerSideProps = async ({ req, res }) => {
      const { nextAdminRouter } = await import(
        "@premieroctet/next-admin/dist/router"
      );
      const adminRouter = await nextAdminRouter(prisma, schema);
      return adminRouter.run(req, res) as Promise<
        GetServerSidePropsResult<{ [key: string]: any }>
      >;
    };
    ```

    It takes 3 parameters:

    - Your Prisma client instance, _required_
    - Your Prisma schema, _required_

    and an _optional_ object of type [`NextAdminOptions`](#next-admin-options) to customize your admin with the following properties:

    ```ts
    import { NextAdminOptions } from "@premieroctet/next-admin";

    const options: NextAdminOptions = {
      model: {
        User: {
          toString: (user) => `${user.email} / ${user.name}`,
        },
      },
    };

    const adminRouter = await nextAdminRouter(prisma, schema, options);
    ```

  </Tabs.Tab>
</Tabs>

## Authentication

<Tabs items={['App router', 'Page router']}>
    <Tabs.Tab>
    The library does not provide an authentication system. If you want to add your own, you can do so by adding a role check in the page:

    > The following example uses [next-auth](https://next-auth.js.org/) to handle authentication

    ```ts
    // app/admin/[[...nextadmin]]/page.tsx

    export default async function AdminPage({
      params,
      searchParams,
    }: {
      params: { [key: string]: string[] };
      searchParams: { [key: string]: string | string[] | undefined } | undefined;
    }) {
      const session = await getServerSession(authOptions);
      const isAdmin = session?.user?.role === "SUPERADMIN"; // your role check

      if (!isAdmin) {
        redirect('/', { permanent: false })
      }

      const props = await getPropsFromParams({
        params: params.nextadmin,
        searchParams,
        options,
        prisma,
        schema,
        action: submitFormAction,
      });

      return <NextAdmin {...props} dashboard={Dashboard} />;
    }
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    The library does not provide an authentication system. If you want to add your own, you can do so by adding a role check to the `getServerSideProps` function:

    > The following example uses [next-auth](https://next-auth.js.org/) to handle authentication

    ```ts
    // pages/api/admin/[[...nextadmin]].ts

    export const getServerSideProps: GetServerSideProps = async ({ req, res }) => {
      const session = await getServerSession(req, res, authOptions);
      const isAdmin = session?.user?.role === "SUPERADMIN"; // your role check

      if (!isAdmin) {
        return {
          redirect: {
            destination: "/",
            permanent: false,
          },
        };
      }

      const { nextAdminRouter } = await import(
        "@premieroctet/next-admin/dist/nextAdminRouter"
      );
      return nextAdminRouter(client).run(req, res);
    };
    ```

  </Tabs.Tab>
</Tabs>

## `<NextAdmin />` component

`<NextAdmin />` is a React component that contains the entire UI of Next Admin. It can take several props:

- `AdminComponentProps`, which are passed by the [router function](#nextadminrouter-function) via getServerSideProps
- `options` used to customize the UI, like field formatters for example. Do not use with App router.
- `dashboard` used to customize the rendered dashboard

> ⚠️ : Do not override these `AdminComponentProps` props, they are used internally by Next Admin.

This is an example of using the `NextAdmin` component with a custom Dashboard component and options:

```tsx
// pages/admin/[[...nextadmin]].tsx
import Dashboard from "../../components/CustomDashboard";

export default function Admin(props: AdminComponentProps) {
  /* Props are passed from the nextAdminRouter function via getServerSideProps */
  return (
    <NextAdmin
      {...props}
      dashboard={Dashboard}
      options={{
        model: {
          User: {
            list: {
              display: ["id", "name", "email", "posts", "role", "birthDate"],
              search: ["name", "email"],
              fields: {
                role: {
                  formatter: (role) => {
                    return <strong>{role.toString()}</strong>;
                  },
                },
                birthDate: {
                  formatter: (date) => {
                    return new Date(date as unknown as string)
                      ?.toLocaleString()
                      .split(" ")[0];
                  },
                },
              },
            },
          },
        },
      }}
    />
  );
}
```

## Next Admin Options

Next Admin options is the third parameter of the [router function](#nextadminrouter-function) and it's an object of options that has the following properties:

### `model`

`model` is an object that represents the customization options for each model in your schema.

It takes as **_key_** a model name of your schema as **_value_** an object to customize your it.

By default if no models are defined, they will all be displayed in the admin. If you want more control, you have to define each model individually as empty objects or with the following properties:

| Name       | Description                                                                     | Default value |
| ---------- | ------------------------------------------------------------------------------- | ------------- |
| `toString` | a function that is used to display your record in related list                  | `id` field    |
| `title`    | a string used to display the model name in the sidebar and in the section title | Model name    |

You can customize the following for each model:

- ##### `list` property

This property determines how your data is displayed in the [List View](/docs/glossary#list-view)

| Name    | Description                                                             | Default value             |
| ------- | ----------------------------------------------------------------------- | ------------------------- |
| search  | an array of searchable fields                                           | all fields are searchable |
| display | an array of fields that are displayed in the list                       | all fields are displayed  |
| fields  | an object containing the model fields as keys, and customization values | undefined                 |

> Note that the `search` property is only available for `scalar` fields.

- ##### `edit` property

This property determines how your data is displayed in the [edit view](/docs/glossary#edit-view)

| Name    | Description                                                             | Default value            |
| ------- | ----------------------------------------------------------------------- | ------------------------ |
| display | an array of fields that are displayed in the form                       | all fields are displayed |
| fields  | an object containing the model fields as keys, and customization values | undefined                |

##### `fields` property

The `fields` property is available in both `list` and `edit` properties.

For the `list` property, it can take the following:

| Name      | Description                                                                                                                                                                |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| formatter | a function that takes the field value as a parameter, and that return a JSX node. It also accepts a second argument which is the [`NextAdmin` context](#nextadmin-context) |

For the `edit` property, it can take the following:

| Name           | Description                                                                                                                                                                  |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| validate       | a function that takes the field value as a parameter, and that returns a boolean                                                                                             |
| format         | a string defining an OpenAPI field format, overriding the one set in the generator. An extra `file` format can be used to be able to have a file input                       |
| input          | a React Element that should receive [CustomInputProps](#custominputprops). For App Router, this element must be a client component.                                          |
| handler        | an object that can take the following properties                                                                                                                             |
| handler.get    | a function that takes the field value as a parameter and returns a transformed value displayed in the form                                                                   |
| handler.upload | an async function that is used only for formats `file` and `data-url`. It takes a buffer as parameter and must return a string. Useful to upload a file to a remote provider |

### `pages`

`pages` is an object that allows you to add your own sub pages as a sidebar menu entry. It is an object where the key is the path (without the base path) and the value is an object with the following properties:

| Name    | Description                                    |
| ------- | ---------------------------------------------- |
| `title` | the title of the page displayed on the sidebar |

Here is an example of using `NextAdminOptions` for the following schema :

```prisma
// prisma/schema.prisma
enum Role {
  USER
  ADMIN
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  password  String   @default("")
  posts     Post[]   @relation("author") // One-to-many relation
  profile   Profile? @relation("profile") // One-to-one relation
  birthDate DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  role      Role     @default(USER)
}
```

```tsx
// pages/api/admin/[[...nextadmin]].ts
const options: NextAdminOptions = {
  basePath: "/admin",
  model: {
    User: {
      toString: (user) => `${user.name} (${user.email})`,
      list: {
        display: ["id", "name", "email", "posts", "role", "birthDate"],
        search: ["name", "email"],
        fields: {
          role: {
            formatter: (role) => {
              return <strong>{role.toString()}</strong>;
            },
          },
          birthDate: {
            formatter: (date) => {
              return new Date(date as unknown as string)
                ?.toLocaleString()
                .split(" ")[0];
            },
          },
        },
      },
      edit: {
        display: ["id", "name", "email", "posts", "role", "birthDate"],
        fields: {
          email: {
            validate: (email) => email.includes("@") || "Invalid email",
          },
          birthDate: {
            format: "date",
          },
          avatar: {
            format: "file",
            handler: {
              upload: async (file: Buffer) => {
                return "https://www.gravatar.com/avatar/00000000000000000000000000000000";
              },
            },
          },
        },
      },
    },
  },
};

const adminRouter = await nextAdminRouter(prisma, schema, options);
```

## CustomInputProps

This is the type of the props that are passed to the custom input component:

| Name      | Description                                                                                                                 |
| --------- | --------------------------------------------------------------------------------------------------------------------------- |
| name      | the field name                                                                                                              |
| value     | the field value                                                                                                             |
| onChange  | a function taking a [ChangeEvent](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event) as a parameter |
| readonly  | boolean indicating if the field is editable or not                                                                          |
| rawErrors | array of strings containing the field errors                                                                                |

## NextAdmin Context

The `NextAdmin` context is an object containing the following properties:

- `locale`: the locale used by the calling page. (refers to the `accept-language` header).
